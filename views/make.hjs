<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>give.pizza</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
    <script src="https://cdn.socket.io/socket.io-1.3.5.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.2.min.js"></script>
    <script src="https://code.jquery.com/jquery-migrate-1.2.1.min.js"></script>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
    <script>
    var finalized = false;
    $(document).ready(function() {
      $('#getStores').click(function() {
        requestStores($('#address').val(), $('#town').val(), $('#state').val(), $('#zip').val());
      });

      $(document).on('blur', '*', function() {
        $('#results').removeClass('error');
      });

      $('#finalizeOrder').click(function() {
        $('#results').text('');
        $('#results').css('display', 'none');
        var storeErrorSet = false;
        var pizzaErrorSet = false;
        var checkList = [
          '#name',
          '#email',
          '#address',
          '#town',
          '#state',
          '#zip',
        ];
        checkList.forEach(function(item){
          if($(item).val() == "") {
            $('#results').append("<b>No " + item.substring(1) + " entered!</b><br>")
                          .css('display', 'block')
                          .removeClass('alert-success')
                          .toggleClass('alert-danger error', true);
          }
          if(!$('.storeSelected').length && !storeErrorSet) {
            $('#results').append("<b>No store selected!</b><br>")
                          .css('display', 'block')
                          .removeClass('alert-success')
                          .toggleClass('alert-danger error', true);
            storeErrorSet = true;
          }
          if(!$('.pizzaSelected').length && !pizzaErrorSet) {
            $('#results').append("<b>No pizza selected!</b><br>")
                          .css('display', 'block')
                          .removeClass('alert-success')
                          .toggleClass('alert-danger error', true);
            pizzaErrorSet = true;
          }

          if(!$('.error').length) { //If there are no errors!
            finalizeOrder($('.storeSelected').attr('id'),
                          $('.pizzaSelected').attr('id'),
                          $('#size').val(),
                          $('#name').val(),
                          $('#email').val(),
                          $('#msg').val(),
                          ($('#address').val() + ',' + $('#town').val() + ',' + $('#state').val() +
                            ',' + $('#zip').val())
            );
          }
        });
      });
    });
    var socket = io('give.pizza:5000');
    function requestStores(address, town, state, zip) {
      socket.emit('getStores', { address: address, town: town, state: state, zip: zip });
    }

    function finalizeOrder(storeId, pizzaId, size, name, email, msg, address) {
      if(!$('#finalizeOrder').prop('disabled')) {
        $('#finalizeOrder').prop('disabled', true);
        socket.emit('finalizeOrder', {
                    storeId: storeId,
                    pizzaId: pizzaId,
                    size: size,
                    name: name,
                    email: email,
                    msg: msg,
                    address: address });
      }
    }

    socket.on('giveStores', function(data) {
      $('#displayPanel').css('display', 'block');
      $('#storeListings').html(data);
    });

    socket.on('orderFinalized', function(data) {
      $('#results').html(data)
                   .css('display', 'block')
                   .addClass('alert-success')
                   .removeClass('alert-danger');
    });

    function gotClicked(id, className) {
      if($('#' + id).parent().hasClass('btn-default') && !$('.' + className)[0]) {
        $('#' + id).addClass(className)
                   .parent()
                   .css('background-color', '#6495ed')
                   .removeClass('btn-default')
      }
      else {
        if($('.' + className)[0].id == id) {
            $('#' + id).removeClass(className)
                       .parent()
                       .css('background-color', '')
                       .addClass('btn-default');
        }
      }
    }
    </script>
    <div id="banner" class="row">
      <div class="col-md-12">
        <div class="page-header">
          <h1 style="margin-left:5px">
            <a style="text-decoration:none;color:black" href="/">give.pizza</a>
            <small>Make</small>
          </h1>
        </div>
      </div>
    </div>
    <div class="container panel panel-default">
        <br>
        <div class="row">
            <div class="col-md-8">
                <form>
                    <div class="form-group">
                        <label for="address">Address</label>
                        <input type="text" class="form-control" id="address" placeholder="Address">
                    </div>
                    <div class="form-group">
                        <label for="town">Town</label>
                        <input type="text" class="form-control" id="town" placeholder="Town">
                    </div>
                    <div class="form-group">
                        <label for="zip">State</label>
                        <input type="text" class="form-control" id="state" placeholder="State">
                    </div>
                    <div class="form-group">
                        <label for="zip">Zip</label>
                        <input type="text" class="form-control" id="zip" placeholder="Zip">
                    </div>
                    <button id="getStores" type="button" class="btn btn-default">Find a store!</button>
                </form>
            </div>
        </div>
        <br>
        <div id="displayPanel" class="panel panel-default" style="display:none">
            <div class="panel-heading">Stores near you:</div>
            <ul id="storeListings" class="panel-body list-group">
            </ul>
        </div>
        <div id="pizzaPanel" class="panel panel-default">
            <div class="panel-heading">Pick a pizza!</div>
            <ul id="storeListings" class="panel-body list-group">
                <li class="container list-group-item btn-default" style="width:inherit">
          <div id="cheese" onclick="gotClicked(this.id, 'pizzaSelected')">Cheese</div>
        </li>
                <li class="container list-group-item btn-default" style="width:inherit">
          <div id="pepperoni" onclick="gotClicked(this.id, 'pizzaSelected')">Pepperoni</div>
        </li>
                <li class="container list-group-item btn-default" style="width:inherit">
          <div id="sausage" onclick="gotClicked(this.id, 'pizzaSelected')">Sausage</div>
        </li>
            </ul>
      <label for="size" style="margin-left:5px">Pizza size</label>
      <br>
      <select id="size" class="form-control" style="width:15%;margin-left:10px">
        <option value="10">Small</option>
        <option value="12">Medium</option>
        <option value="14">Large</option>
        <option value="16">X-Large</option>
      </select>
      <br>
        </div>
        <br>
        <form>
            <div class="form-group" style="width:400px">
                <label for="name">Your name</label>
                <input type="text" class="form-control" id="name" placeholder="Name">
            </div>
            <div class="form-group" style="width:400px">
                <label for="email">Your email</label>
                <input type="email" class="form-control" id="email" placeholder="Email">
            </div>
            <div class="form-group" style="width:400px">
                <label for="msg">Message to payer</label>
                <textarea rows="3" class="form-control" id="msg" placeholder="Message"></textarea>
            </div>
            <button id="finalizeOrder" type="button" class="btn btn-default">Finalize my order!</button>
        </form>
        <br>
        <div id="results" class="alert" style="display:none"></div>
    </div>
</body>
</html>
