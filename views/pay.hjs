<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>give.pizza</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.2.min.js"></script>
    <script src="https://code.jquery.com/jquery-migrate-1.2.1.min.js"></script>
    <script type="text/javascript" src="https://js.stripe.com/v2/"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
    <script>
    var socket = io('http://give.pizza:5000');
    Stripe.setPublishableKey('pk_test_tBpAD31uGVOhN7q5cHzawwM8');
    $(function() {
      $('#sendPizza').click(function() {
          $('#checkout').modal('show');
          var paySubmit = $('#submit');
          paySubmit.on('click', function() {
              paySubmit.prop('disabled', true);
              paySubmit.button('progress');

              setTimeout(function() {
                  paySubmit.addClass('btn-success').removeClass('btn-primary');
                  paySubmit.button('success');
                  $('#checkout').modal('hide');
              }, 1500);

              /*var cardNum = $('#card-num').val();
              var cardExp = $('#card-exp').val().split('/');
              var cardCVC = $('#card-cvc').val();

              // First submit the card information to Stripe to get back a token
              Stripe.card.createToken({
                  number: cardNum,
                  exp_month: cardExp[0],
                  exp_year: cardExp[1],
                  cvc: cardCVC
              }, function(status, response) {
                  console.log("Submitted!");
                  var payForm = $('#form');
                  var token = response.id;

                  // Save the token into a hidden input field
                  payForm.append($('<input type="hidden" name="stripeToken" />').val(token));

                  // Now submit the form to our server so it can make the charge against the token
                  payForm.get(0).submit();

                  // All done!
                  setTimeout(function() {
                      $('#checkout').modal('hide');
                  }, 250);
              });*/

              return false;
          });
      });

      $(document).on('blur', '*', function() {
        $('#results').removeClass('error');
      });
    });

    $(document).on('blur', '#cc', function() {  //Changes CC image depending on the credit card
        var result = $('#cc').validateCreditCard({
         accept: ['visa', 'mastercard', 'amex']
        });

        if((!result.length_valid || !result.luhn_valid) && !$('.badcc').length) {
            $('#results').append("<b>Credit card number is not valid!</b><br>")
                         .css('display', 'block')
                         .removeClass('alert-success')
                         .toggleClass('alert-danger error badcc', true);
        }
        else {
            if(!$('.badcc').length) {
                $('#ccimg').attr('src', '/public/images/' + result.card_type.name + '.png');
            }
        }
    });

    socket.on('orderComplete', function(data) {
      $('#results').html(data)
                   .css('display', 'block')
                   .addClass('alert-success')
                   .removeClass('alert-danger');
    });

    </script>
    <div id="banner" class="row">
      <div class="col-md-12">
        <div class="page-header">
          <h1 style="margin-left:5px">
            <a style="text-decoration:none;color:black" href="/">give.pizza</a>
            <small>Pay</small>
          </h1>
        </div>
      </div>
    </div>
    <div class="container panel panel-default">
    <br>
        <form>
            <div class="form-group">
                <label for="name">First name</label>
                <p class="form-control-static" id="name">{{friendName}}</p>
            </div>
      <div class="form-group">
        <label for="total">Order total:</label>
        <p class="form-control-static" id="total">${{orderTotal}}</p>
      </div>
      {{#friendMsg}}
            <div class="form-group">
                <label for="msg">Message</label>
                <p class="form-control-static" id="msg">{{friendMsg}}</p>
            </div>
      {{/friendMsg}}
        </form>
        <div id="displayPanel" class="panel panel-default" style="display:none">
            <div class="panel-heading">Stores near you:</div>
            <ul id="storeListings" class="panel-body list-group">
            </ul>
        </div>
        <div id="pizzaPanel" class="panel panel-default">
            <div class="panel-heading">Selected pizza</div>
            <ul id="storeListings" class="panel-body list-group">
                <li class="container list-group-item" style="width:inherit;{{#cheeseSelected}}background-color:#6495ed{{/cheeseSelected}}">
                  <div id="cheese" class="{{cheeseSelected}}">Cheese</div>
                </li>
                <li class="container list-group-item" style="width:inherit;{{#pepperoniSelected}}background-color:#6495ed{{/pepperoniSelected}}">
                  <div id="pepperoni" class="{{pepperoniSelected}}">Pepperoni</div>
                </li>
                <li class="container list-group-item" style="width:inherit;{{#sausageSelected}}background-color:#6495ed{{/sausageSelected}}">
                  <div id="sausage" class="{{sausageSelected}}">Sausage</div>
                </li>
            </ul>
            <label for="size" style="margin-left:5px">Pizza size: {{size}}"</label>
            <br>
        </div>
        <button id="sendPizza" class="btn btn-default">Send Pizza!</button>
        <br>
        <div class="modal fade" id="checkout">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" id="closeModal">&times;</button>
                    </div>

                    <div class="modal-body">
                        <form id="payForm" action="/charge" method="POST" class="form-horizontal">
                            <div class="form-group">
                                <div class="col-sm-12">
                                    <div class="input-group">
                                        <span class="input-group-addon"><span class="glyphicon glyphicon-credit-card"></span></span>
                                        <input id="card-num" class="form-control" type="text" size="16" placeholder="Card number" autofocus="autofocus" />
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <div class="col-sm-6">
                                    <div class="input-group">
                                        <span class="input-group-addon"><span class="glyphicon glyphicon-calendar"></span></span>
                                        <input id="card-exp" class="form-control" type="text" size="5" placeholder="MM/YY" />
                                    </div>
                                </div>

                                <div class="col-sm-6">
                                    <div class="input-group">
                                        <span class="input-group-addon"><span class="glyphicon glyphicon-lock"></span></span>
                                        <input id="card-cvc" class="form-control" type="text" size="4" placeholder="CVC" />
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>

                    <div class="modal-footer">
                        <button id="submit" type="button" class="btn btn-primary col-sm-12"
                                data-progress-text="<span class='glyphicon glyphicon-refresh fa-spin'></span>"
                                data-success-text="<span class='glyphicon glyphicon-ok'></span>"
                                >
                            Pay ${{orderTotal}}
                        </button><br/>
                    </div>
                    <img src="../public/images/outline.png" class="img-rounded" style="float:left">
                </div>
            </div>
        </div>
        <br>
      </div>
</body>
</html>
